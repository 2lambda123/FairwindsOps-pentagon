# Infrastructure Repository Overview
After running `pentagon start-project` you will have a directory with a layout similiar to:
```
.
├── README.md
├── ansible-requirements.yml
├── components/
├── config/
├── default/
├── docs/
├── plugins/
├── requirements.txt
└── roles/
```
See also [Extended Layout](#extended-layout-description)

Generally speaking, the layout of the infrastructure repository is heierachical. That is to say, higher level directories contain scripts, resources, and variables that are intended to be used earlier in the creation of your infrastructure. This is intended for the `default/` and `config/` directories, in particular. 
*Consider this a guidline, not a rule!*

## Core Directories

### config/
The config directory is separated into `local` and `private`. Files, scripts, and templates in `config/local` are checked into source control and should not contain any workstation specific values. 

`config/local/env-vars.sh` uses a specific list of variable names, locates the values in `config/local/vars.yml` and `config/private/secrets.yml` and exports them as an environment variable. These environment variables are used throughout the infrastructure repository so make sure you `source config/local/env-vars.sh`. 

Some configurations require absolute paths which, if checked into source control, can make working with teams challenging. The `config/local/local-config-init` script makes this easier by providing a fast way to generate workstation specific configurations from the `ansible.cfg-default` and `ssh_config-default` template files. The generated workstation specific configuration files are written to `config/private`. 

`config/private/ssh_config` and `config/private/ansible.cfg` greatly simplify interaction with your cloud VMs. It is configured to automatically use the correct key and user name based on the IP address of the host. You can either use the command `ssh -F '${INFRASTRUCTURE_REPO}/config/local/ssh_config` or alias SSH with `alias ssh="ssh -F '${INFRASTRUCTURE_REPO}/config/local/ssh_config'`.

`config/private`, in addition to `secrets.yml` also contains SSH keys generated by `start-project`. Unless you opted to not create the keys, the `admin-vpn` key pair will be uploaded to AWS for you when the VPN instance is created and the `*-kube` keys will automatically be uploaded when `kops` is invoked to create the Kubernetes cluster. The other keys, `production-private`, `working-private` are created as a convenience to be used for any instances that are created in the VPC `private-working` and `private-production` subnets. When `kops` is invoked to create the cluster, the Kubernetes config secret will also be created as `config/private/kube_config`

### default/
The `default/` contains most of the moving parts of the infrastructure repository. The name `default` is not important! The contents are. The goal is that the contents of the `default` directory can be deep copied and create parallel (cloud provider, cloud account, vpc) infrastructure in a single repository. *Consider this a guidline, not a rule!*

```
├── account
├── clusters
├── resources
└── vpc
```

### default/account/
Contains `vars.sh` and `vars.yaml`. `vars.sh` contains environment variables important to `kops.sh` discussed later. It must be sourced when using kops. `vars.yml` contains configuration values important for Ansible and in `resources/admin-environment/vpn.yml` discussed later. 

### default/clusters/
Contains `working/` and `production/` directories. Both are laid out identically.
`working` is intended to contain any non-production Kubernetes pods, deployments, services. `production` is intended to contain any production Kubernetes objects pods, deployments, services etc.
```
├── cluster-config
├── kubernetes
├── resources
└── vars.sh
```
`cluster-config/kops.sh` is a bash script that creates the kops `cluster.spec` and uploads it to the S3 bucket set in `default/account/vars.sh`. 
`kubernetes/` is the directory into which Kubernetes manifests _that are not application specific_ can be stored
`vars.sh` must be sourced when working with the kops cluster. Keep in mind that `default/clusters/working/vars.sh` has different values than `default/cluster/production/vars.sh` so make sure you source the correct file for the cluster you are working on. 

### default/cluster/<working|production>/resource
This `resources/` is the directory into which Ansible playbooks to create _cluster specific_ cloud resources can be stored

### default/resources
This `resources/` is the directory into which Ansible playbooks to _non cluster specific_ cloud resources can be stored. The `admin-environment` playbook, which creates and configures the OpenVPN instance, is present "out of the box".

## Supporting Directories

### plugins/
This is the Ansible plugins directory. The `ec2` infrastructure plugin is enabled by default. Set in `config/private/ansible.cfg`.

### roles/
The Ansible roles are installed here by default. Set in `config/private/ansible.cfg`.

### components/
Components are a work in progress. The intended functionality is to provide modularity to portions of the Pentagon ecosystem with a command similar to `pentagon add vpc <name>`. This could allow a much more flexible structure while still utilizing the generator functionality of the Pentagon CLI


## Extended Layout Description

```
├── README.md 
├── ansible-requirements.yml
├── components/                                                 * components are WIP
├── config/                                                     * Configuration Directory
│   ├── local/                                                  * Local, non-secret configuration and 
│   │   ├── ansible.cfg-default                                   templating code to create private configuration
│   │   ├── env-vars.sh
│   │   ├── local-config-init
│   │   ├── ssh_config-default
│   │   ├── vars -> ../private/vars
│   │   └── vars.yml
│   └── private/                                                * Private, secret configs. ignored by git
│       ├── admin-vpn                                           * SSH key pairs generated by at `start-project`
│       ├── admin-vpn.pub
│       ├── production-kube
│       ├── production-kube.pub
│       ├── production-private
│       ├── production-private.pub                                               
│       ├── working-kube
│       ├── working-kube.pub
│       ├── working-private
│       ├── working-private.pub
│       └── secrets.yml                                         * Secret values in yaml config file
├── default/                                                    * Directory for default cloud provider accoung and clusters 
│   ├── account/                                                * Variable files for default account in default cluster
│   │   ├── vars.sh
│   │   └── vars.yml
│   ├── clusters/                                               * Directory for Clusters
│   │   ├── production/                                         * Directory for production Kubernetes cluster
│   │   │   ├── cluster-config/
│   │   │   │   └── kops.sh                                     * Shell script to create production cluster with Kops
│   │   │   ├── kubernetes/                                     * Directory for Kubernets manifests that are not application specific
│   │   │   ├── resources/                                      * Directory for infrastructre code required for production cluster (ansible playbooks etc)
│   │   │   └── vars.sh                                         * Variables specific to production Kuberentes cluster
│   │   └── working/                                            * Directory for working Kubernetes cluster. Identical in layout to production
│   ├── resources/                                              * Directory for infratstructure code that is not cluster specific (ansible playbooks etc)
│   │   └── admin-environment                                   * Ansible playbook for creating the OpenVPN instance  
│   └── vpc/                                                    * Terraform to create the VPC. 
│       ├── Makefile
│       ├── main.tf
│       ├── terraform.tfvars
│       └── variables.tf
├── docs                                        
├── plugins                                                     * Ansible plugins                                  
├── roles                                                       * Ansible roles installed by `ansible-requirements.yml`
└── requirements.txt
```

